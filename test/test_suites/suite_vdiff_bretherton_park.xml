<?xml version="1.0" encoding="UTF-8"?>
<!--
  Bretherton and Park (UW, diag_TKE) eddy diffusivity scheme and vertical diffusion.
  The first part of this file is for the UW scheme to compute the exchange coefficients
  iteratively (also dependent on the diffusion solver).
  The second part is the vertical diffusion solver,
  independent of the TMS drag which is assumed to be an input to this test SDF.
-->
<suite name="vdiff_bretherton_park" version="1.0">
  <group name="physics_before_coupler">
    <scheme>initialize_constituents</scheme>
    <scheme>to_be_ccppized_temporary</scheme>

    <!-- read namelist options -->
    <scheme>vertical_diffusion_options</scheme>

    <!-- stub: zero UBC -->
    <scheme>zero_upper_boundary_condition</scheme>

    <!-- init phase only: for setting vertical diffusion top -->
    <scheme>hb_diff_set_vertical_diffusion_top</scheme>

    <!-- stub: Beljaars is zero (not enabled for CAM5/not implemented) -->
    <scheme>beljaars_zero_stub</scheme>

    <!-- vdiff pre-interstitial 0: create p coords1d and potential temp. -->
    <scheme>vertical_diffusion_prepare_inputs</scheme>

    <!-- vdiff pre-interstitial 1: copy surface fluxes from coupler (cam_in)
         wsx and wsy from coupler are needed for implicit surface stress
         calculations later on in the diffusion solver. -->
    <scheme>hb_diff_prepare_vertical_diffusion_inputs</scheme>

    <!-- vdiff pre-interstitial 2: interpolate t, rho, p to interfaces -->
    <!-- not in WACCM-X mode so do not use rairv in vdiff. -->
    <scheme>vertical_diffusion_not_use_rairv</scheme>
    <scheme>vertical_diffusion_set_temperature_at_toa_default</scheme>
    <scheme>vertical_diffusion_interpolate_to_interfaces</scheme>

    <!-- UW eddy diffusivity scheme -->
    <scheme>bretherton_park_diff</scheme>
    <scheme>compute_kinematic_fluxes_and_obklen</scheme>
    <scheme>eddy_diffusivity_adjustment_above_pbl</scheme>

    <!-- sponge layer vertical diffusion (mutate kvm) -->
    <scheme>vertical_diffusion_sponge_layer</scheme>

    <!-- diagnostics -->

    <!-- vdiff pre-interstitial 3: calculate drag coefficient -->
    <scheme>implicit_surface_stress_add_drag_coefficient</scheme>
    <scheme>turbulent_mountain_stress_add_drag_coefficient</scheme>

    <!-- vdiff pre-interstitial 4: calculate damping rate from drag coef. -->
    <scheme>vertical_diffusion_wind_damping_rate</scheme>
    <!--<scheme>beljaars_add_wind_damping_rate</scheme>-->

    <!-- vdiff compute 1: horizontal momentum diffusion; dissipate KE -->
    <!-- note: vdiff compute schemes calculate "provisional" updates,
         but these updates are not applied as physics tendencies until the end. -->
    <scheme>vertical_diffusion_diffuse_horizontal_momentum</scheme>

    <!-- set dry static energy top boundary condition to zero.
         zero is used for: no molecular diffusion, or molecular diffusion + WACCM-X is active.
         otherwise, use vertical_diffusion_set_dry_static_energy_at_toa_molecdiff -->
    <scheme>vertical_diffusion_set_dry_static_energy_at_toa_zero</scheme>

    <!-- vdiff compute 2: dry static energy diffusion -->
    <scheme>vertical_diffusion_diffuse_dry_static_energy</scheme>

    <!-- vdiff compute 3: tracer diffusion -->
    <scheme>vertical_diffusion_diffuse_tracers</scheme>

    <!-- vdiff post-interstitial 1: convert provisional updates to tendencies -->
    <scheme>vertical_diffusion_tendencies</scheme>

    <!-- diagnostics need to be outputted before tendencies are applied. -->
    <!--<scheme>vertical_diffusion_tendencies_diagnostics</scheme>-->
    <!-- note hplin tautotx/tautoty breaks here i think we should just make a tau
         for total surface stress (and not name it for hb) so it is explicit what
         is being used .... -->

    <!-- apply tendencies from vdiff -->
    <scheme>apply_tendency_of_northward_wind</scheme>
    <scheme>apply_tendency_of_eastward_wind</scheme>
    <scheme>apply_constituent_tendencies</scheme>
    <scheme>apply_heating_rate</scheme>
    <scheme>qneg</scheme>
    <scheme>geopotential_temp</scheme>
    <scheme>update_dry_static_energy</scheme>
  </group>
</suite>
